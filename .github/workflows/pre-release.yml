name: Pre-release Build

on:
  # Manual trigger with platform selection
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'macos'
        type: choice
        options:
          - macos
          - linux
          - all
  # Auto build DMG for PRs
  pull_request:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  build-macos:
    # For PR: always run. For manual: check platform input
    if: ${{ github.event_name == 'pull_request' || inputs.platform == 'macos' || inputs.platform == 'all' }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core

      - name: Build Rust core (universal)
        run: |
          cd core
          cargo build --release --target aarch64-apple-darwin
          cargo build --release --target x86_64-apple-darwin
          lipo -create \
            target/aarch64-apple-darwin/release/libgonhanh_core.a \
            target/x86_64-apple-darwin/release/libgonhanh_core.a \
            -output ../platforms/macos/libgonhanh_core.a

      - name: Build macOS app
        run: |
          cd platforms/macos
          xcodebuild -scheme GoNhanh -configuration Release \
            -derivedDataPath build CODE_SIGN_IDENTITY="-"

      - name: Get version from latest tag
        id: version
        run: |
          git fetch --tags
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          BASE_VERSION="${LATEST_TAG#v}"
          SHORT_SHA="${GITHUB_SHA:0:7}"
          BUILD_NUM="${GITHUB_RUN_NUMBER}"
          VERSION="${BASE_VERSION}-pre.${BUILD_NUM}.${SHORT_SHA}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Pre-release version: $VERSION (build #${BUILD_NUM})"

      - name: Create DMG
        run: |
          cd platforms/macos
          APP="build/Build/Products/Release/GoNhanh.app"
          V="${{ steps.version.outputs.version }}"

          # Set version in app
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $V" "$APP/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $V" "$APP/Contents/Info.plist"

          # Create DMG
          ../../scripts/create-dmg.sh "$APP" || {
            # Fallback: simple DMG if script fails
            hdiutil create -volname "GoNhanh" -srcfolder "$APP" -ov -format UDZO "build/GoNhanh-${V}.dmg"
          }

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: GoNhanh-${{ steps.version.outputs.version }}-macOS
          path: platforms/macos/build/*.dmg
          retention-days: 14

      - name: Get DMG filename
        if: github.event_name == 'pull_request'
        id: dmg
        run: |
          DMG_FILE=$(ls platforms/macos/build/*.dmg | head -1)
          DMG_NAME=$(basename "$DMG_FILE")
          echo "file=$DMG_FILE" >> $GITHUB_OUTPUT
          echo "name=$DMG_NAME" >> $GITHUB_OUTPUT

      - name: Upload to pre-release
        if: github.event_name == 'pull_request'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: pr-${{ github.event.pull_request.number }}
          name: "PR #${{ github.event.pull_request.number }} Preview"
          prerelease: true
          files: ${{ steps.dmg.outputs.file }}
          body: |
            ðŸ”„ Auto-generated preview build for PR #${{ github.event.pull_request.number }}

            **Latest Version:** `${{ steps.version.outputs.version }}`
            **Latest Commit:** ${{ github.sha }}

            > âš ï¸ This release is updated on each push. Download links for specific commits are in PR comments.

      - name: Comment on PR with new DMG
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.version.outputs.version }}
          DMG_NAME: ${{ steps.dmg.outputs.name }}
          COMMIT_SHA: ${{ github.sha }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const shortSha = process.env.COMMIT_SHA.substring(0, 7);
            const version = process.env.VERSION;
            const dmgName = process.env.DMG_NAME;
            const prNumber = process.env.PR_NUMBER;
            const downloadUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/releases/download/pr-${prNumber}/${dmgName}`;

            const body = [
              '## ðŸ“¦ macOS Build Ready',
              '',
              '| Commit | Version | Download |',
              '|--------|---------|----------|',
              `| \`${shortSha}\` | \`${version}\` | [â¬‡ï¸ **${dmgName}**](${downloadUrl}) |`,
              '',
              `> ðŸ”— Build for commit ${process.env.COMMIT_SHA}`
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(prNumber),
              body: body
            });

  build-linux:
    # Only for manual trigger (not PR) - Linux build is optional
    if: ${{ github.event_name == 'workflow_dispatch' && (inputs.platform == 'linux' || inputs.platform == 'all') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            fcitx5 \
            libfcitx5core-dev \
            libfcitx5config-dev \
            libfcitx5utils-dev \
            fcitx5-modules-dev \
            extra-cmake-modules \
            libxkbcommon-dev \
            cmake \
            pkg-config

      - name: Build Rust core
        run: cargo build --manifest-path core/Cargo.toml --release

      - name: Build Fcitx5 addon
        run: |
          cd platforms/linux
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)

      - name: Get version from latest tag
        id: version
        run: |
          git fetch --tags
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          BASE_VERSION="${LATEST_TAG#v}"
          SHORT_SHA="${GITHUB_SHA:0:7}"
          BUILD_NUM="${GITHUB_RUN_NUMBER}"
          VERSION="${BASE_VERSION}-pre.${BUILD_NUM}.${SHORT_SHA}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Pre-release version: $VERSION (build #${BUILD_NUM})"

      - name: Package
        run: |
          V="${{ steps.version.outputs.version }}"
          cd platforms/linux
          mkdir -p dist
          cp build/src/libgonhanh.so dist/
          cp -r data/* dist/
          cp ../../core/target/release/libgonhanh_core.so dist/ || true
          tar -czvf "gonhanh-${V}-linux.tar.gz" -C dist .

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: GoNhanh-${{ steps.version.outputs.version }}-Linux
          path: platforms/linux/*.tar.gz
          retention-days: 14
